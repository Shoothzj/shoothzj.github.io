---
title: 网络通信超时之后该不该重启客户端
date: 2023-07-08 14:06:21
tags:
---
我写这篇文章来论证”超时之后要不要重启客户端“、”我该怎么重启客户端“。简而言之，重启客户端还是为了让系统能够达到自愈，是比较高的可靠性要求。如果你的软件没有这么高的可靠性要求，像是人机交互程序等对可靠性要求较低的场景，可以选择不考虑这个功能。毕竟实现这个功能的时间至少够300倍你重新点击按钮/重启的时间了。

在网络通信报文不会遭到篡改的时候，也没有宇宙射线/太阳黑子修改你的比特位的场景下，笔者认为没有特别大的必要对客户端进行重启操作，因为不见得重启后就比之前更好，这种超时通常是由服务端处理时间长导致的。没做到建链限制的情况下，贸然地重启，还可能会引起建链的波峰。

但是，在网络报文会遭到篡改的情况下，一切就大不一样了，这其中的关键在于，切分报文是否正确。

如果是老派一点的协议，通过传输的间隙来判断报文的间隔，就像modbus一些串口协议一样，3.5个时间内不发送，就计算做一个协议报文的开始，那么故障时的报文毫无疑问会处理失败（因为存在CRC校验，奇偶校验等）。等待故障结束，又3.5个时间后，就会恢复正常。

但倘若是当前流行的，LengthBasedFrame，那可就大不一样了，这种协议，通常根据前0~4个字节来判断协议的总长度，比如前面的字节是**00000014**，那这个报文长度就是1*16+4 = 20长度。这种时候，一旦发生了报文篡改，尤其是高位篡改，会导致通信端计算报文长度出错，一直在傻等，无法自愈。

综上来说，如果在有报文篡改的场景下，一旦出现通信超时，这条链路会无法自愈。这种情况下，我们推荐对tcp链路做超时的重建，业内的一些例子像是：bookkeeper client没有做，kafka client做了。至于重建的敏感情况，比如一次超时就重建，还是多次超时之后才重建，这些就交给读者自己把握了。我会倾向于做一次超时就重建，逻辑简单清晰。
